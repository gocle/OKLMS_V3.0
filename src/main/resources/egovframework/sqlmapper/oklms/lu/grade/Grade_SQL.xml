<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
  ~ *******************************************************************************
  ~  * COPYRIGHT(C) 2016 SMART INFORMATION TECHNOLOGY. ALL RIGHTS RESERVED.
  ~  * This software is the proprietary information of SMART INFORMATION TECHNOLOGY..
  ~  *
  ~  * Revision History
  ~  * Author   Date            Description
  ~  * ======   =========      ====================================
  ~  * 이진근    2017. 01. 23          First Draft.
  ~  *
  ~  *******************************************************************************
  -->

<mapper namespace="kr.co.gocle.oklms.lu.grade.service.impl.GradeMapper">

	
	
	<select id="listGradeSendStatusList" parameterType="kr.co.gocle.oklms.lu.grade.vo.GradeVO" resultType="kr.co.gocle.oklms.lu.grade.vo.GradeVO">
		/* ====== kr.co.gocle.oklms.lu.grade.service.impl.GradeMapper.listGradeSendStatusList ====== */
		SELECT LES.YYYY, 
			       LES.TERM,
			       CASE 
			       WHEN LES.TERM = '1' THEN '101'
			       WHEN LES.TERM = '2' THEN '102'
			       WHEN LES.TERM = '3' THEN '103'
			       ELSE '4'
			       END SEMSTR_CD,
			       MEM.DEPT_NO,
			       MEM.COMPANY_ID,
			       COUNT(DISTINCT MEM.MEM_SEQ) AS STU_CNT, 
			       FN_GETCOMPAYNAME(MEM.COMPANY_ID) AS COMPANY_NAME, 
			       
			       <!-- GROUP_CONCAT(DISTINCT FN_GETUSERID(MEM.MEM_SEQ)) AS GROUP_MEM_IDS,  -->
			       
			       LISTAGG(FN_GETUSERID(MEM.MEM_SEQ), ',') WITHIN 
						       GROUP( 
						     ORDER BY FN_GETUSERID(MEM.MEM_SEQ)) AS GROUP_MEM_IDS, 
			       
			       (SELECT DECODE(COUNT(*),0,'N','Y')
			         FROM LMS_GRADE_SUBMIT GRD 
			        WHERE GRD.DELETE_YN = 'N' 
			              AND GRD.YYYY = LES.YYYY 
			              AND GRD.TERM = LES.TERM 
			              AND GRD.DEPT_NO = MEM.DEPT_NO 
			              AND GRD.COMPANY_ID = MEM.COMPANY_ID 
			       ) AS SEND_YN 
			  FROM LMS_LESSON LES 
			     INNER JOIN COM_MEMBER MEM 
			         ON LES.MEM_SEQ = MEM.MEM_SEQ 
			       AND MEM.DELETE_YN = 'N' 
			       AND MEM.MEM_TYPE = 'STD' 
			       AND MEM.OUT_YN = 'N'
			       <!-- AND NVL(MEM.COMPANY_ID,'') != ''  -->
			       AND MEM.DEPT_NO = #{sessionDeptNo}
			 WHERE LES.DELETE_YN = 'N' 
			       AND LES.YYYY = #{yyyy}  
			       AND LES.TERM = #{term} 
			       AND LES.LEC_STATUS = 'A' 
			   GROUP BY LES.YYYY, 
					       LES.TERM, 
					       MEM.COMPANY_ID, 
					       CASE 
					           WHEN LES.TERM = '1' 
					           THEN '101' 
					           WHEN LES.TERM = '2' 
					           THEN '102' 
					           WHEN LES.TERM = '3'  
					           THEN '103' 
					           ELSE '4' 
					       END, 
					       MEM.DEPT_NO, 
					       FN_GETCOMPAYNAME(MEM.COMPANY_ID)	       
	</select>
	
	
	<select id="listGradeSendList" parameterType="kr.co.gocle.oklms.lu.grade.vo.GradeVO" resultType="kr.co.gocle.oklms.lu.grade.vo.GradeVO">
		/* ====== kr.co.gocle.oklms.lu.grade.service.impl.GradeMapper.listGradeSendList ====== */
		SELECT TO_CHAR(GRD.INSERT_DATE,'YYYY.MM.DD') AS INSERT_DATE,
				   COM.COMPANY_NAME, 
			       COM.COMPANY_NO, 
			       GRD.IP, 
			       GRD.SUBMIT_COMMENT, 
			       GRD.CONFIRM_YN, 
			       TO_CHAR(GRD.CONFIRM_DATE,'YYYY.MM.DD') AS CONFIRM_DATE, 
			       
			       <!-- (SELECT DISTINCT GROUP_CONCAT(FN_GETUSERNAME(CCM.MEM_SEQ)) 
			         FROM LMS_SUBJ_CCM_MAPPING CCM 
			        WHERE CCM.DELETE_YN = 'N' 
			              AND CCM.COMPANY_ID = GRD.COMPANY_ID 
			       ) CCM_NAME --> 
			       
			       (SELECT 
			       		<!-- GROUP_CONCAT(FN_GETUSERNAME(MEM.MEM_SEQ))  -->
			       		LISTAGG(FN_GETUSERNAME(MEM.MEM_SEQ), ',') WITHIN 
						       GROUP( 
						     ORDER BY FN_GETUSERNAME(MEM.MEM_SEQ))
			       		FROM COM_MEMBER MEM 
			       		WHERE MEM.DELETE_YN = 'N'
			              AND MEM.COMPANY_ID = GRD.COMPANY_ID 
			              AND MEM.MEM_TYPE = 'CCM'
			       ) CCM_NAME
			       
			  FROM LMS_GRADE_SUBMIT GRD 
			     INNER JOIN LMS_COMPANY COM 
			         ON GRD.COMPANY_ID = COM.COMPANY_ID 
			       AND COM.DELETE_YN = 'N' 
			 WHERE GRD.DELETE_YN = 'N' 
			       AND GRD.YYYY = #{yyyy} 
			       AND GRD.TERM = #{term}
			       AND GRD.DEPT_NO = #{sessionDeptNo}
	</select>
	
	
	<insert id="insertGradeCdpSend" parameterType="kr.co.gocle.oklms.lu.grade.vo.GradeVO" >
		/* ====== kr.co.gocle.oklms.lu.grade.service.impl.GradeMapper.insertGradeCdpSend ====== */
		INSERT INTO LMS_GRADE_SUBMIT
			       (
			         SUBMIT_ID
			         ,COMPANY_ID
			         ,YYYY
			         ,TERM
			         ,SUBMIT_COMMENT
			         ,DEPT_NO
			         ,IP
			         ,INSERT_USER
			         ,INSERT_DATE
			       ) 
			       VALUES
			       ( 
			         #{submitId}
			         ,#{companyId}
			         ,#{yyyy}
			         ,#{term}
			         ,#{submitComment}
			         ,#{deptNo}
			         ,#{sessionIp}
			         ,#{sessionMemSeq}
			         ,SYSDATE  
			       )
	</insert>
	
	
	<select id="getGradeGroupMemIds" parameterType="kr.co.gocle.oklms.lu.grade.vo.GradeVO" resultType="String">
		/* ====== kr.co.gocle.oklms.lu.grade.service.impl.GradeMapper.getGradeGroupMemIds ====== */
		SELECT <!-- GROUP_CONCAT(DISTINCT MEM.MEM_ID)   -->
				LISTAGG(MEM.MEM_ID, ',') WITHIN 
				GROUP( 
				ORDER BY MEM.MEM_ID)
		
			  FROM LMS_GRADE_SUBMIT GRD 
			     INNER JOIN LMS_LESSON LES 
			         ON GRD.YYYY = LES.YYYY 
			       AND GRD.TERM = LES.TERM 
			       AND LES.DELETE_YN = 'N' 
			       AND LES.LEC_STATUS = 'A' 
			     INNER JOIN COM_MEMBER MEM 
			         ON GRD.DEPT_NO = MEM.DEPT_NO 
			       AND GRD.COMPANY_ID = MEM.COMPANY_ID 
			       AND LES.MEM_SEQ = MEM.MEM_SEQ 
			       AND MEM.DELETE_YN = 'N' 
			 WHERE GRD.DELETE_YN = 'N' 
			       AND GRD.DEPT_NO = #{deptNo} 
			       AND GRD.COMPANY_ID = #{sessionCompanyId}  
			       AND GRD.YYYY = #{yyyy} 
			       AND GRD.TERM = #{term} 
			  <!--  GROUP BY MEM.MEM_ID -->	       
	</select>
	
	
	<select id="getGradeCcmConfirmInfo" parameterType="kr.co.gocle.oklms.lu.grade.vo.GradeVO" resultType="kr.co.gocle.oklms.lu.grade.vo.GradeVO">
		/* ====== kr.co.gocle.oklms.lu.grade.service.impl.GradeMapper.getGradeCcmConfirmInfo ====== */
		SELECT SUBMIT_ID
			   ,CONFIRM_YN 
			   ,SUBMIT_COMMENT 
			   ,TO_CHAR(GRD.INSERT_DATE,'YYYY.MM.DD') AS INSERT_DATE 
		       ,FN_GETCODENAME('DEPT_CD',DEPT_NO) AS DEPT_NM 
		       ,FN_GETUSERNAME(GRD.INSERT_USER) AS INSERT_USER_NAME 
		       ,TO_CHAR(GRD.CONFIRM_DATE,'YYYY.MM.DD') AS CONFIRM_DATE 
		       ,GRD.CONFIRM_YN 
		       ,GRD.IP 
			FROM LMS_GRADE_SUBMIT GRD 
		 WHERE GRD.DELETE_YN = 'N' 
		       AND GRD.DEPT_NO = #{deptNo} 
		       AND GRD.COMPANY_ID = #{sessionCompanyId}  
		       AND GRD.YYYY = #{yyyy} 
		       AND GRD.TERM = #{term} 
	</select>
	
	<select id="getGradeCcmSubmitInfo" parameterType="kr.co.gocle.oklms.lu.grade.vo.GradeVO" resultType="kr.co.gocle.oklms.lu.grade.vo.GradeVO">
		/* ====== kr.co.gocle.oklms.lu.grade.service.impl.GradeMapper.getGradeCcmSubmitInfo ====== */
		SELECT SUBMIT_ID
			   ,CONFIRM_YN 
			   ,SUBMIT_COMMENT 
			   ,TO_CHAR(GRD.INSERT_DATE,'YYYY.MM.DD') AS INSERT_DATE 
		       ,FN_GETCODENAME('DEPT_CD',DEPT_NO) AS DEPT_NM 
		       ,FN_GETUSERNAME(GRD.INSERT_USER) AS INSERT_USER_NAME 
		       ,TO_CHAR(GRD.CONFIRM_DATE,'YYYY.MM.DD') AS CONFIRM_DATE 
		       ,GRD.CONFIRM_YN 
		       ,GRD.IP 
			FROM LMS_GRADE_SUBMIT GRD 
		 WHERE GRD.DELETE_YN = 'N' 
		       AND GRD.SUBMIT_ID = #{submitId} 
		       AND GRD.COMPANY_ID = #{sessionCompanyId}  
	</select>
	
	<select id="listGradeConfirmList" parameterType="kr.co.gocle.oklms.lu.grade.vo.GradeVO" resultType="kr.co.gocle.oklms.lu.grade.vo.GradeVO">
		/* ====== kr.co.gocle.oklms.lu.grade.service.impl.GradeMapper.listGradeConfirmList ====== */
		SELECT SUBMIT_ID
				,SUBMIT_COMMENT 
		       ,TO_CHAR(GRD.INSERT_DATE,'YYYY.MM.DD') AS INSERT_DATE 
		       ,FN_GETCODENAME('DEPT_CD',DEPT_NO) AS DEPT_NM 
		       ,FN_GETUSERNAME(GRD.INSERT_USER) AS INSERT_USER_NAME 
		       ,TO_CHAR(GRD.CONFIRM_DATE,'YYYY.MM.DD') AS CONFIRM_DATE 
		       ,CONFIRM_YN 
		       ,IP 
		  FROM LMS_GRADE_SUBMIT GRD 
		 WHERE GRD.DELETE_YN = 'N' 
		       AND GRD.YYYY = #{yyyy} 
			   AND GRD.TERM = #{term} 
		       AND GRD.COMPANY_ID = #{sessionCompanyId}
		      ORDER BY GRD.INSERT_DATE DESC 	       
	</select>
	
	
	<update id="updateGradeCcmConfirmY" parameterType="kr.co.gocle.oklms.lu.grade.vo.GradeVO">
		/* ====== kr.co.gocle.oklms.lu.grade.service.impl.GradeMapper.updateGradeCcmConfirmY ====== */
		UPDATE LMS_GRADE_SUBMIT 
		       SET CONFIRM_YN = 'Y'
		       ,CONFIRM_USER = #{sessionMemSeq} 
		       ,CONFIRM_DATE = SYSDATE 
		 WHERE SUBMIT_ID = #{submitId} 	       
	</update>
	
	
	

</mapper>
