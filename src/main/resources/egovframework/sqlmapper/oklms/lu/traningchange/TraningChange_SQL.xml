<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
  ~ *******************************************************************************
  ~  * COPYRIGHT(C) 2016 SMART INFORMATION TECHNOLOGY. ALL RIGHTS RESERVED.
  ~  * This software is the proprietary information of SMART INFORMATION TECHNOLOGY..
  ~  *
  ~  * Revision History
  ~  * Author   Date            DescriptionlistTraningChangeScheduleDisapproved
  ~  * ======   =========      ====================================
  ~  * 이진근    2017. 03. 27     First Draft.
  ~  *
  ~  *******************************************************************************
  -->

<mapper namespace="kr.co.gocle.oklms.lu.traningchange.service.impl.TraningChangeMapper">

	<sql id="list-where">
		<if test="sessionMemSeq != null and sessionMemSeq != ''">
			AND A.UPDATE_USER = #{sessionMemSeq} /* HRD담당자, 기업현장교사 일떼만 */
	    </if>
	</sql>

	<sql id="listAliasNo-where">
		<if test="sessionMemSeq != null and sessionMemSeq != ''">
			AND UPDATE_USER = #{sessionMemSeq} /* 기업현장교사 일떼만 */
	    </if>
	</sql>

	<sql id="listCot-where">
		<if test="sessionMemSeq != null and sessionMemSeq != ''">
			AND A.UPDATE_USER = #{sessionMemSeq} /* HRD담당자, 기업현장교사 일떼만 */
	    </if>
	</sql>

	<sql id="listCcn-where">
   
       	<if test="searchCompanyName != null and searchCompanyName != ''">
			AND C.COMPANY_ID = #{searchCompanyName}
	    </if>
	    <if test="searchTraningProcessName != null and searchTraningProcessName != ''">
			AND C.TRANING_PROCESS_ID = #{searchTraningProcessName}
	    </if>
	    <if test="searchSubjectName != null and searchSubjectName != ''">
			AND C.SUBJECT_CODE = #{searchSubjectName}
	    </if>
	    <if test="searchStartUpdateDate != null and searchStartUpdateDate != ''">
	    	AND A.UPDATE_DATE >= #{searchStartUpdateDate}
	    </if>
	    <if test="searchEndUpdateDate != null and searchEndUpdateDate != ''">
	    	AND #{searchEndUpdateDate} >= A.UPDATE_DATE
	    </if>
	    
	    
	</sql>

	<!-- 승인된 변경신청 내역 목록 엑셀다운로드 -->
	<select id="listTraningChangeScheduleApprovedExcelDownload" parameterType="kr.co.gocle.oklms.lu.traning.vo.TraningScheduleVO" resultType="kr.co.gocle.oklms.lu.traning.vo.TraningScheduleVO">
		/* ====== kr.co.gocle.oklms.lu.traningchange.service.impl.listTraningChangeScheduleApprovedExcelDownload ====== */
			select a.COMPANY_ID,
			       a.TRANING_PROCESS_ID,
			       FN_GETCOMPAYNAME(a.COMPANY_ID) company_name,
			       FN_GETTRANING_PROCESS_NAME(a.TRANING_PROCESS_ID) HRD_TRANING_NAME,
			       a.YYYY,
			       a.TERM,
			       a.SUBJECT_CODE,
			       a.CLASS as subClass,
			       c.SUBJECT_NAME,
			       e.mem_seq,
			       e.mem_id,
			       e.mem_name,
			       e.mem_type
			  from lms_traning_process_mapping a
			  inner join lms_subject c
			  on c.YYYY = a.YYYY
			  and c.TERM = a.TERM
			  and c.SUBJECT_CODE = a.SUBJECT_CODE
			  and c.CLASS = a.CLASS
			  and c.SUBJECT_TRANING_TYPE = 'OJT'
			  and c.DELETE_YN = 'N'
			  left outer join lms_subj_tut_mapping d
			  on d.YYYY = c.YYYY
			  and d.TERM = c.TERM
			  and d.SUBJECT_CODE = c.SUBJECT_CODE
			  and d.CLASS = c.CLASS
			  and d.DELETE_YN = 'N'
			  left outer join com_member e
			  on e.mem_seq = d.mem_seq
			  where 1 = 1
			  and a.DELETE_YN = 'N'
			  and a.COMPANY_ID = #{companyId}
			  and a.TRANING_PROCESS_ID = #{traningProcessId}
			  and a.yyyy = #{yyyy}
			  and a.TERM = #{term}
			  and a.SUBJECT_CODE = #{subjectCode}
			  and a.CLASS = #{subClass}
	</select>

	<!-- 미승인 변경신청 목록 -->
	<select id="listTraningChangeScheduleDisapproved" parameterType="kr.co.gocle.oklms.lu.traning.vo.TraningScheduleVO" resultType="kr.co.gocle.oklms.lu.traning.vo.TraningScheduleVO">
		/* ====== kr.co.gocle.oklms.lu.traningchange.service.impl.listTraningChangeScheduleDisapproved ====== */
			SELECT DISTINCT
			<!--  A.WEEK_ID, -->
			 MAX(A.WEEK_ID) WEEK_ID, 
					 A.YYYY,
			       A.TERM,
			       A.SUBJECT_CODE,
			       A.CLASS as subClass,
			       A.CHANGE_REASON,
			       A.IP_ADDRESS,
			       A.RETUN_REASON,
			       CASE 
					WHEN A.CHANGE_STATUS = '1' THEN '승인대기' 
					WHEN A.CHANGE_STATUS = '2' THEN '승인'
					WHEN A.CHANGE_STATUS = '3' THEN '반려'
					ELSE '승인대기'
					END as CHANGE_STATUS_NAME,
			        
			        
			        A.CHANGE_STATUS,
			       TO_CHAR (MAX(A.UPDATE_DATE), 'YYYY.MM.DD') as UPDATE_DATE,
			       FN_GETSUBJECT_NAME(A.YYYY, A.TERM, A.SUBJECT_CODE, A.CLASS) AS SUBJECT_NAME,
			       MAX(FN_GETUSERNAME(A.UPDATE_USER)) AS MEM_NAME,
			        (SELECT B.COMPANY_ID
			          FROM lms_traning_process_mapping B
			          WHERE 1 = 1
			          AND B.YYYY = A.YYYY
			          AND B.TERM = A.TERM
			       	  AND B.SUBJECT_CODE = A.SUBJECT_CODE
			          AND B.CLASS = A.CLASS
			          AND B.DELETE_YN = 'N'
			          AND ROWNUM = 1
			        ) AS COMPANY_ID,
			        (SELECT FN_GETCOMPAYNAME(B.COMPANY_ID)
			          FROM lms_traning_process_mapping B
			          WHERE 1 = 1
			          AND B.YYYY = A.YYYY
			          AND B.TERM = A.TERM
			       	  AND B.SUBJECT_CODE = A.SUBJECT_CODE
			          AND B.CLASS = A.CLASS
			          AND B.DELETE_YN = 'N'
			          AND ROWNUM = 1
			        ) AS COMPANY_NAME,
			        (SELECT B.TRANING_PROCESS_ID
			          FROM lms_traning_process_mapping B
			          WHERE 1 = 1
			          AND B.YYYY = A.YYYY
			          AND B.TERM = A.TERM
			       	  AND B.SUBJECT_CODE = A.SUBJECT_CODE
			          AND B.CLASS = A.CLASS
			          AND B.DELETE_YN = 'N'
			          AND ROWNUM = 1
			        ) AS TRANING_PROCESS_ID,
			        (SELECT FN_GETTRANING_PROCESS_NAME(B.TRANING_PROCESS_ID)
			          FROM lms_traning_process_mapping B
			          WHERE 1 = 1
			          AND B.YYYY = A.YYYY
			          AND B.TERM = A.TERM
			       	  AND B.SUBJECT_CODE = A.SUBJECT_CODE
			          AND B.CLASS = A.CLASS
			          AND B.DELETE_YN = 'N'
			          AND ROWNUM = 1
			        ) AS HRD_TRANING_NAME
			  FROM lms_traning_subj_week_sch A
			 WHERE 1 = 1
			       AND A.DELETE_YN = 'N'
			       AND A.CHANGE_REASON IS NOT NULL
			<!-- 기업현장교사 일떼만 세션에서 교과정보 메핑 -->
			<if test="sessionAuthGroupId != null  and sessionAuthGroupId != '' ">
				<if test="sessionAuthGroupId == '2016AUTH0000008'">
				   AND A.YYYY= #{yyyy}
				   AND A.TERM= #{term}
				   AND A.SUBJECT_CODE= #{subjectCode}
				   AND A.CLASS=#{subClass}	
				</if>
			</if>
			
			
			<!-- hrd 담당자일경우 본인 회사만 조회 -->
		   <if test="sessionMemType == 'CCM' and sessionCompanyId != null and sessionCompanyId != ''">
		    	AND A.CHANGE_STATUS in ('1','3')    
		   		AND 
		       (
		         YYYY,
		         TERM,
		         SUBJECT_CODE,
		         CLASS
		       ) 
		       IN 
		       (SELECT YYYY,
		              TERM,
		              SUBJECT_CODE,
		              CLASS 
		         FROM LMS_TRANING_PROCESS_MAPPING 
		        WHERE DELETE_YN = 'N' 
		        AND COMPANY_ID =  #{sessionCompanyId}
		       )
		   </if> 	
		   
		   
		   <!-- 센터 담당자일경우 본인 회사만 조회 -->
		   <if test="sessionMemType == 'CCN' and sessionMemType != null and sessionMemType != ''">
		    	AND A.CHANGE_STATUS in ('1','3')    
		   		AND ( YYYY,TERM,SUBJECT_CODE,CLASS) IN
					(
						SELECT MAP.YYYY,
				                     MAP.TERM,
				                     MAP.SUBJECT_CODE,
				                     MAP.CLASS 
				                FROM LMS_TRANING_PROCESS_MAPPING MAP 
				                   INNER JOIN LMS_COMP_CCN_MAPPING CCN 
				                       ON MAP.COMPANY_ID = CCN.COMPANY_ID 
				                     AND CCN.DELETE_YN = 'N' 
				                     AND CCN.MEM_SEQ = #{sessionMemSeq} 
				               WHERE MAP.DELETE_YN = 'N' 
					)
		   </if>
		   
		   GROUP BY 
		   	<!-- 	A.WEEK_ID,  -->
		   		A.YYYY,
			       A.TERM,
			       A.SUBJECT_CODE,
			       A.CLASS,
			       A.CHANGE_REASON,
			       A.CHANGE_STATUS,
			       A.IP_ADDRESS,
			       A.RETUN_REASON 
			 ORDER BY A.YYYY||A.TERM||A.SUBJECT_CODE||A.CLASS
			<!-- ORDER BY A.WEEK_ID DESC -->
		
	</select>

	<!-- 승인된 변경이력 목록 -->
	<select id="listTraningChangeScheduleApproved" parameterType="kr.co.gocle.oklms.lu.traning.vo.TraningScheduleVO" resultType="kr.co.gocle.oklms.lu.traning.vo.TraningScheduleVO">
		/* ====== kr.co.gocle.oklms.lu.traningchange.service.impl.listTraningChangeScheduleApproved ====== */
			SELECT DISTINCT   A.YYYY,
		       A.TERM,
		       A.SUBJECT_CODE,
		       A.CLASS as subClass,
		       A.CHANGE_REASON,
		       TO_CHAR (A.UPDATE_DATE, 'YYYY.MM.DD') as UPDATE_DATE,
		       FN_GETSUBJECT_NAME(A.YYYY, A.TERM, A.SUBJECT_CODE, A.CLASS) AS SUBJECT_NAME,
		       FN_GETUSERNAME(A.UPDATE_USER) AS MEM_NAME,
		       DECODE(A.CHANGE_STATUS , '2', '승인', '반려') as CHANGE_STATUS_NAME,
		        A.CHANGE_STATUS,
		        C.COMPANY_ID,
                FN_GETCOMPAYNAME(C.COMPANY_ID) AS COMPANY_NAME,
                C.TRANING_PROCESS_ID,
                FN_GETTRANING_PROCESS_NAME(C.TRANING_PROCESS_ID) AS HRD_TRANING_NAME,
                A.WEEK_ID
		  FROM lms_traning_subj_week_sch A ,
			   (SELECT DISTINCT A.TERM,A.YYYY,A.SUBJECT_CODE,A.CLASS,B.COMPANY_ID,B.TRANING_PROCESS_ID
		        FROM   lms_traning_subj_week_sch A,lms_traning_process_mapping B
		        WHERE     A.DELETE_YN = 'N'
					       AND A.CHANGE_STATUS IN ( '2', '3' )
					       AND A.CHANGE_REASON IS NOT NULL
							 AND   B.YYYY = A.YYYY
		               AND B.TERM = A.TERM
		               AND B.SUBJECT_CODE = A.SUBJECT_CODE
		               AND B.CLASS = A.CLASS
		               AND B.DELETE_YN = 'N'
							) C
		 WHERE     A.DELETE_YN = 'N'
		       AND A.CHANGE_STATUS IN ('2','3')
		       AND A.CHANGE_REASON IS NOT NULL

       AND C.YYYY = A.YYYY
       AND C.TERM = A.TERM
       AND C.SUBJECT_CODE= A.SUBJECT_CODE
       AND C.CLASS = A.CLASS
     
	    
		<if test="sessionAuthGroupId != null  and sessionAuthGroupId != '' ">
			<!-- 기업현장교사 일떼 -->
		<if test="sessionAuthGroupId == '2016AUTH0000008'">
			<include refid="listCot-where"/>
		</if>
		<!-- 센터전담자 혹은 HRD전담자 일떼 -->
			<if test="sessionAuthGroupId == '2016AUTH0000004' or sessionAuthGroupId == '2016AUTH0000005'">
				<include refid="listCcn-where"/>
			</if>
		</if>

		<!-- hrd 담당자일경우 본인 회사만 조회 -->
	    <if test="sessionMemType == 'CCM' and sessionCompanyId != null and sessionCompanyId != ''">   
	   		AND  C.COMPANY_ID =  #{sessionCompanyId}
	    </if>

			ORDER BY A.WEEK_ID DESC
	</select>

	<!-- 훈련시간표 변경신청 상세 목록 -->
	<select id="listTraningChangeScheduleDisapprovedDetail" parameterType="kr.co.gocle.oklms.lu.traning.vo.TraningScheduleVO" resultType="kr.co.gocle.oklms.lu.traning.vo.TraningScheduleVO">
	/* ====== kr.co.gocle.oklms.lu.traningchange.service.impl.listTraningChangeScheduleDisapprovedDetail ====== */
			select
			      
			      TO_CHAR(TO_DATE(TRANING_DATE,'YYYY.MM.DD'), 'dy', 'NLS_DATE_LANGUAGE=korean') AS DAY_OF_WEEK,
			      TO_CHAR(TO_DATE(CHANGE_TRANING_DATE,'YYYY.MM.DD'), 'dy', 'NLS_DATE_LANGUAGE=korean') AS DAY_OF_WEEK_CHANGE,
			      a.WEEK_ID,
			      a.TIME_ID,
			      b.WEEK_CNT,
			      a.YYYY,
			      a.TERM,
			      a.SUBJECT_CODE,
			      a.CLASS,
			      a.TRANING_DATE,
			      a.TRANING_ST_HOUR,
			      a.TRANING_ST_MIN,
			      a.TRANING_ED_HOUR,
			      a.TRANING_ED_MIN,
			      a.CHANGE_TRANING_DATE,
			      a.CHANGE_TRANING_ST_HOUR,
			      a.CHANGE_TRANING_ST_MIN,
			      a.CHANGE_TRANING_ED_HOUR,
			      a.CHANGE_TRANING_ED_MIN,
			      a.LEAD_TIME,
			      a.LEAD_TIME,
			      a.CHANGE_LEAD_TIME,
			      a.INSERT_DATE,
			      a.INSERT_USER,
			      a.UPDATE_DATE,
			      a.CHANGE_YN
			from lms_traning_subj_week_time_sch a
			inner join lms_traning_subj_week_sch b
			on b.WEEK_ID = a.WEEK_ID
			and b.YYYY = a.YYYY
			and b.TERM = a.TERM
			and b.SUBJECT_CODE = a.SUBJECT_CODE
			and b.CLASS = a.CLASS
			where 1 = 1
			and a.DELETE_YN = 'N'
			and a.yyyy = #{searchYyyy}
			and a.TERM = #{searchTerm}
			and a.SUBJECT_CODE = #{searchSubjectCode}
			and a.CLASS = #{searchSubClass}
			order by b.WEEK_ID asc, a.TRANING_DATE asc

	</select>

	<!-- 훈련과정시간표 변경신청건 변경사유 수정 처리시 -->
	<update id="updateTraningChangeSchedule" parameterType="kr.co.gocle.oklms.lu.traning.vo.TraningScheduleVO">
		/* ====== kr.co.gocle.oklms.lu.traningchange.service.impl.updateTraningChangeSchedule ====== */
			UPDATE LMS_TRANING_SUBJ_WEEK_SCH
			SET UPDATE_DATE = SYSDATE
			   ,UPDATE_USER = #{sessionMemSeq}
			   ,CHANGE_STATUS = '1'
			   ,CHANGE_REASON = #{changeReason}
			WHERE 1=1
			and yyyy = #{searchYyyy}
			and TERM = #{searchTerm}
			and SUBJECT_CODE = #{searchSubjectCode}
			and CLASS = #{searchSubClass}
			<!-- 기업현장교사 일떼만 아래 검색조건 추가 -->
<!-- 			<if test="sessionAuthGroupId != null and sessionAuthGroupId != '' ">
				<if test="sessionAuthGroupId == '2016AUTH0000008'">
					<include refid="listAliasNo-where"/>
				</if>
			</if> -->   
	</update>

	<!-- 훈련과정시간표 변경신청건 훈련일자 수정 처리시 -->
	<update id="updateTraningChangeScheduleTime" parameterType="kr.co.gocle.oklms.lu.traning.vo.TraningScheduleVO">
		/* ====== kr.co.gocle.oklms.lu.traningchange.service.impl.updateTraningChangeScheduleTime ====== */
			UPDATE LMS_TRANING_SUBJ_WEEK_TIME_SCH
			SET UPDATE_DATE = SYSDATE
			   ,UPDATE_USER = #{sessionMemSeq}
			   ,CHANGE_TRANING_DATE = #{changeTraningDate}
			   ,CHANGE_TRANING_ST_HOUR = #{changeTraningStHour}
			   ,CHANGE_TRANING_ST_MIN = '00'
			   ,CHANGE_TRANING_ED_HOUR = #{changeTraningEdHour}
			   ,CHANGE_TRANING_ED_MIN = '00'
			   ,CHANGE_LEAD_TIME = #{changeLeadTime}
			   <if test="changeYn != null and changeYn != ''">
			   	   ,CHANGE_YN = #{changeYn}
			   </if>   
			WHERE 1=1
			AND TIME_ID = #{timeId}
			and yyyy = #{searchYyyy}
			and TERM = #{searchTerm}
			and SUBJECT_CODE = #{searchSubjectCode}
			and CLASS = #{searchSubClass}
			<!-- 기업현장교사 일떼만 아래 검색조건 추가 -->
<!-- 			<if test="sessionAuthGroupId != null and sessionAuthGroupId != '' ">
				<if test="sessionAuthGroupId == '2016AUTH0000008'">
					<include refid="listAliasNo-where"/>
				</if>
			</if> -->
	</update>

	<!-- 센터담당자가 승인 혹은 반려처리시 실제사용하는 주차별시간 테이블에 훈련일자를 변경일자로 업데이트 -->
	<update id="updateSubjWeekTime" parameterType="kr.co.gocle.oklms.lu.traning.vo.TraningScheduleVO">
		/* ====== kr.co.gocle.oklms.lu.traningchange.service.impl.updateSubjWeekTime ====== */
			UPDATE LMS_SUBJ_WEEK_TIME
			SET UPDATE_DATE = SYSDATE
			   ,UPDATE_USER = #{sessionMemSeq}
			   ,TRANING_DATE = #{changeTraningDate}
			   ,TRANING_ST_HOUR = #{changeTraningStHour}
			   ,TRANING_ST_MIN = #{changeTraningStMin}
			   ,TRANING_ED_HOUR = #{changeTraningEdHour}
			   ,TRANING_ED_MIN = #{changeTraningEdMin}
			   ,LEAD_TIME = #{changeLeadTime}
			WHERE 1=1
			and yyyy = #{searchYyyy}
			and TERM = #{searchTerm}
			and SUBJECT_CODE = #{searchSubjectCode}
			and CLASS = #{searchSubClass}
			and TRANING_DATE = #{traningDate}
			and TRANING_ST_HOUR = #{traningStHour}
			and TRANING_ST_MIN = #{traningStMin}
			and TRANING_ED_HOUR = #{traningEdHour}
			and TRANING_ED_MIN = #{traningEdMin}
			and LEAD_TIME = #{leadTime}
	</update>

	<!-- 센터담당자가 승인 처리시 -->
	<update id="updateTraningChangeScheduleStatus" parameterType="kr.co.gocle.oklms.lu.traning.vo.TraningScheduleVO">
		/* ====== kr.co.gocle.oklms.lu.traningchange.service.impl.updateTraningChangeScheduleStatus ====== */
			UPDATE LMS_TRANING_SUBJ_WEEK_SCH
			SET UPDATE_DATE = SYSDATE
			   ,CHANGE_STATUS = #{changeStatus}
			WHERE 1=1
			and yyyy = #{yyyy}
			and TERM = #{term}
			and SUBJECT_CODE = #{subjectCode}
			and CLASS = #{subClass}
	</update>

	<!-- 센터담당자가 승인 반려처리시 -->
	<update id="updateTraningChangeScheduleStatusApprovalNot" parameterType="kr.co.gocle.oklms.lu.traning.vo.TraningScheduleVO">
		/* ====== kr.co.gocle.oklms.lu.traningchange.service.impl.updateTraningChangeScheduleStatusApprovalNot ====== */
			UPDATE LMS_TRANING_SUBJ_WEEK_SCH
			SET UPDATE_DATE = SYSDATE
			   ,UPDATE_USER = #{sessionMemSeq}
			   ,CHANGE_STATUS = #{changeStatus}
			   ,RETUN_REASON = #{retunReason}
			WHERE 1=1
			and yyyy = #{yyyy}
			and TERM = #{term}
			and SUBJECT_CODE = #{subjectCode}
			and CLASS = #{subClass}
	</update>

	<!-- HRD담당자, 기입현장교사가 삭제처리시 -->
	<update id="deleteTraningChangeScheduleDisapproved" parameterType="kr.co.gocle.oklms.lu.traning.vo.TraningScheduleVO">
		/* ====== kr.co.gocle.oklms.lu.traningchange.service.impl.updateTraningChangeScheduleStatusApprovalNot ====== */
			UPDATE LMS_TRANING_SUBJ_WEEK_SCH
			SET UPDATE_DATE = SYSDATE
			   ,UPDATE_USER = #{sessionMemSeq}
			   ,CHANGE_REASON = NULL
			WHERE 1=1
			and yyyy = #{yyyy}
			and TERM = #{term}
			and SUBJECT_CODE = #{subjectCode}
			and CLASS = #{subClass}
	</update>

	<!-- HRD담당자, 기입현장교사가 삭제처리시 -->
	<delete id="deleteTraningChangeScheduleTimeDisapproved" parameterType="kr.co.gocle.oklms.lu.traning.vo.TraningScheduleVO">
		/* ====== kr.co.gocle.oklms.lu.traningchange.service.impl.deleteTraningChangeScheduleDisapproved ====== */
			UPDATE LMS_TRANING_SUBJ_WEEK_TIME_SCH
			SET UPDATE_DATE = SYSDATE
			   ,UPDATE_USER = #{sessionMemSeq}
			   ,CHANGE_TRANING_DATE = NULL
			   ,CHANGE_TRANING_ST_HOUR = NULL
			   ,CHANGE_TRANING_ST_MIN = NULL
			   ,CHANGE_TRANING_ED_HOUR = NULL
			   ,CHANGE_TRANING_ED_MIN = NULL
			   ,CHANGE_LEAD_TIME = NULL
			WHERE 1=1
			and yyyy = #{yyyy}
			and TERM = #{term}
			and SUBJECT_CODE = #{subjectCode}
			and CLASS = #{subClass}
	</delete>

</mapper>
